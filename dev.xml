<project default="qtjambi" basedir=".">
    <import file="./build.xml"/>

    <property name="MailLogger.mailhost" value="smtp.trolltech.com" />
    <property name="MailLogger.from" value="[ant-mail]" />
    <property name="MailLogger.failure.notify" value="true" />
    <property name="MailLogger.success.notify" value="true" />
    <property name="MailLogger.failure.to" value="hfroilan@trolltech.com" />
    <property name="MailLogger.success.to" value="hfroilan@trolltech.com" />

    <property name="reportDir" value="reports" />
    <property name="htmlDir"   value="/var/www/junit/" />
<!--    <property name="config"    value="debug" /> -->
    <property name="deployDir" value="./deploy" />
    <property name="eclipseDir" value="../eclipse/main" />

    <target name="clean.report"
            description="Clean report directory.">
         <delete dir="${reportDir}" />
	 <mkdir dir="${reportDir}" />
    </target>

    <target name="sync"
            description="P4 sync ...">
        <exec executable="p4" dir=".">
            <arg line="sync ..." />
        </exec>
    </target>

    <target name="sync.qt"
            description="P4 sync QTDIR">
        <exec executable="p4" dir="${qt}">
            <arg line="sync ${qt}/..." />
        </exec>
    </target>

    <target name="configure.qt"
            description="Configure qt with Qt Jambi configurations.">
        <exec executable="${qt}/configure" dir="${qt}">
            <arg line="-${config} -no-qt3support -fast -release -no-rpath -no-xfixes -fast -shared" />
	</exec>
    </target>

    <target name="generator.autotests"
            description="Run the generator on the autotests.">
        <mkdir dir="${outputDir}/com/trolltech/autotests" />
	<generator dir="autotestlib"
	           header="global.h"
                   typesystem="build.txt" 
		   outputDirectory=".."/>
    </target>

    <target name="compile.qt"
            depends="sync.qt, configure.qt"
            description="Sync, configure, and compile qt.">
	<make dir="${qt}" target="distclean" />
	<make dir="${qt}" />
    </target>

    <target name="compile.autotests" 
            description="Compile Java and c++ files for autotests.">
        <qmake dir="autotestlib" recursive="true" config="${config}"/>
	<make dir="autotestlib" target="clean" />
	<make dir="autotestlib" silent="true"/>
        <javac srcdir="${sourceDir}" destdir="${outputDir}" >
            <include name="com/trolltech/autotests/**.java" />
        </javac>
    </target>

    <target name="lrelease"
            description="Update the example_no.ts for testing.">
        <exec executable="lrelease">
            <arg line="./com/trolltech/examples/examples_no.ts" />
        </exec>
    </target>

    <target name="deploy.clean">
        <delete dir="${deployDir}" />
        <mkdir dir="${deployDir}" />
    </target>

    <target name="deploy.jar">
        <jar destfile="${deployDir}/qtjambi.jar">
            <manifest>
                <attribute name="Built-By" value="Trolltech ASA - ${TODAY}"/>
                <attribute name="Main-Class" value="com.trolltech.launcher.Launcher"/>
            </manifest>
            <fileset dir="${outputDir}" />
            <fileset dir="${sourceDir}">
                <include name="com/trolltech/**/*.png" />
                <include name="com/trolltech/**/*.html" />
                <include name="com/trolltech/**/*.svg" />
		<include name="com/trolltech/**/*.qm" />
                <include name="com/trolltech/examples/ResourceSystem.jar" />
            </fileset>
        </jar>
    </target>

    <target name="deploy.linux"
            depends="deploy.clean, deploy.jar"
            description="Create a deploy dir for linux.">
        <mkdir dir="${deployDir}/lib" />
	<exec executable="sh">
	    <arg line='-c "cp -d ${jambiLib}/*.so* ${deployDir}/lib/."' />
	</exec>

	<exec executable="sh">
	    <arg line='-c "cp -d ${qtLib}/*.so* ${deployDir}/lib/."' />
	</exec>

        <copy todir="${deployDir}/plugins">
            <fileset dir="./plugins">
                <include name="**" />
            </fileset>
        </copy>
        <copy file="bin/juic" todir="${deployDir}/bin" />

        <copy file="${qt}/bin/designer" todir="${deployDir}/bin" />

        <copy todir="${deployDir}">
            <fileset dir="./dist/linux">
                <include name="*" />
            </fileset>
        </copy>
        <chmod file="${deployDir}/bin/*" perm="+x"/>
        <chmod file="${deployDir}/designer.sh" perm="+x"/>
        <chmod file="${deployDir}/generator_example.sh" perm="+x"/>
        <chmod file="${deployDir}/qtjambi.sh" perm="+x"/>
    </target>

    <target name="deploy.zip"
            description="Create a zip file out of deploy dir.">
        <zip destfile="jambi-devel.zip"
             basedir="${deployDir}"/>
    </target>

    <target name="deploy.tar.gz"
            description="Make a tar.gz file out of deploy dir.">
        <tar tarfile="jambi-devel.tar" basedir="${deployDir}"/>
        <gzip zipfile="jambi-devel.tar.gz" src="jambi-devel.tar"/>
        <delete file="jambi-devel.tar" />
    </target>

    <target name="test" 
            depends="clean.report" 
            description="JUnit test with web report">
        <junit printsummary="yes" haltonfailure="false">

            <jvmarg value="-Djava.library.path=${qtLib}:${jambiLib}"/> 
	    <jvmarg value="-Dcom.trolltech.qt.implicit-loading=false" />
	    <jvmarg value="-Dcom.trolltech.qt.debug"/>

            <classpath>
                <pathelement location="${outputDir}" />
                <pathelement location="${sourceDir}" /> 
            </classpath>
            <formatter type="xml"/>
            <batchtest fork="true" todir="${reportDir}">
                <fileset dir=".">
                    <include name="**/autotests//Test*.java"/>
                </fileset>
            </batchtest>

        </junit>

        <junitreport todir="${reportDir}">
            <fileset dir="${reportDir}">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="frames" todir="${htmlDir}"/>
        </junitreport>
    </target>

    <target name="eclipse" depends="eclipse.qt, eclipse.qtdesignerplugins" />

    <target name="eclipse.qt"
            description="Copy qt lib's to eclipse">
        <delete dir="${eclipseDir}/com.trolltech.qt.linux.x86/lib" />
	<mkdir dir="${eclipseDir}/com.trolltech.qt.linux.x86/lib" />
	<exec executable="sh">
	    <arg line='-c "cp -d ${qtLib}/libQtCore.so* ${eclipseDir}/com.trolltech.qt.linux.x86/lib/."' />
	</exec>
	<exec executable="sh">
	    <arg line='-c "cp -d ${qtLib}/libQtGui.so* ${eclipseDir}/com.trolltech.qt.linux.x86/lib/."' />
	</exec>
	<exec executable="sh">
	    <arg line='-c "cp -d ${qtLib}/libQtXml.so* ${eclipseDir}/com.trolltech.qt.linux.x86/lib/."' />
	</exec>
	<exec executable="sh">
	    <arg line='-c "cp -d ${qtLib}/libQtScript.so* ${eclipseDir}/com.trolltech.qt.linux.x86/lib/."' />
	</exec>
	<exec executable="sh">
	    <arg line='-c "cp -d ${qtLib}/libQtDesigner.so* ${eclipseDir}/com.trolltech.qt.linux.x86/lib/."' />
	</exec>
	<exec executable="sh">
	    <arg line='-c "cp -d ${qtLib}/libQtDesignerComponents.so* ${eclipseDir}/com.trolltech.qt.linux.x86/lib/."' />
	</exec>
    </target>

    <target name="eclipse.qtdesignerplugins"
            description="Copy designer plugins to eclipse directory.">
        <delete dir="${eclipseDir}/com.trolltech.qtdesignerplugins" />
        <copy todir="${eclipseDir}/com.trolltech.qtdesignerplugins">
            <fileset dir="./plugins/designer">
                <include name="*" />
            </fileset>
        </copy>
    </target>

    <target name="documentation"
            description="Generate documentation">
        <exec executable="qdoc3" dir="doc/config">
            <arg line="qtjambi.qdocconf" />
        </exec>
    </target>

    <target name="ant-qtjambi.jar"
            description="Create a jar containing all the Qt Jambi ant tasks.">
        <mkdir dir="ant-qtjambi" />
    
        <javac srcdir="." destdir="ant-qtjambi">
            <include name="com/trolltech/tools/ant/*.java"/>
	</javac>
    
        <jar destfile="ant-qtjambi.jar">
            <fileset dir="ant-qtjambi" />
        </jar>
        <delete dir="ant-qtjambi" />
    </target>


    <target name="autotests"
            description="Generate code for autotests, and compile it."
            depends="generator.autotests, compile.autotests" />	   

    <target name="all"
            description="Same as qtjambi + tests."
            depends="qtjambi, generator.autotests, compile.autotests, test" />	   

</project>
