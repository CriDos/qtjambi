<project default="qtjambi" basedir=".">

    <property environment="env"/> 

    <tstamp/>

    <property name="sourceDir" value="." />
    <property name="outputDir" value="classes" />

    <property name="jambiLib" value="./lib" />
    <property name="qt"       value="${env.QTDIR}" />
    <property name="qtLib"    value="${qt}/lib" />
    <property name="config"    value="debug" />

    <mkdir dir="${outputDir}" />

    <javac srcdir="." destdir="${outputDir}">
        <include name="com/trolltech/tools/ant/*.java"/>
    </javac>
    
    <taskdef name="juic"      classpath="${outputDir}:ant-qtjambi.jar" classname="com.trolltech.tools.ant.JuicTask"/>
    <taskdef name="qmake"     classpath="${outputDir}:ant-qtjambi.jar" classname="com.trolltech.tools.ant.QMakeTask"/>
    <taskdef name="make"      classpath="${outputDir}:ant-qtjambi.jar" classname="com.trolltech.tools.ant.MakeTask"/>
    <taskdef name="generator" classpath="${outputDir}:ant-qtjambi.jar" classname="com.trolltech.tools.ant.GeneratorTask"/>

    <target name="help"
            description="Provide detailed help">
        <echo>To get a description of all tasks, run: ant -projecthelp</echo>
	<echo/>
	<echo>To compile everything, just run ant</echo>
    </target>

    <target name="clean"
            description="Clean everything.">
        <delete dir="${outputDir}" />
        <delete dir="${jambiLib}" />
    </target>

    <target name="qmake.qtjambi"
            description="Run qmake on the Qt Jambi project.">
        <delete dir="${jambiLib}" />
	<qmake recursive="true" config="${config} sanitycheck"/>
    </target>

    <target name="qmake.generator"
            description="Run qmake on the generator.">
	<qmake config="release" dir="generator"/>
    </target>

    <target name="compile.generator" depends="qmake.generator"
            description="Compile the Qt Jambi generator.">
        <make dir="generator" target="clean" />
        <make dir="generator" />
    </target>

    <target name="generator.qtjambi" 
            description="Run the Qt Jambi generator on the Qt source. It will use the Qt version found at the QTDIR variable.">
        <generator dir="generator"
		   outputDirectory=".."/>
    </target>

    <target name="generator.generator-example" 
            description="Run the generator on the generator example, qmake it, and compile it.">
        <generator dir="generator_example"
	           header="global.h"
                   typesystem="typesystem_generatorexample.txt" 
		   outputDirectory=".."/>
        <qmake recursive="true" config="${config}" dir="generator_example" />

    </target>

    <target name="compile.qtjambi" 
            description="Compile the c++ QT Jambi bindings">
	<make />
    </target>

    <target name="juic"
            description="Generates Java source files out of JUI files, created by designer.">
        <juic message="Running Juic for all it is worth"
	      outputDir="${sourceDir}"
	      xmlConfigFile=""
              trFunction=""
              classNamePrefix=""
              alwaysUpdate="true"
	      classpath=".">
	     <include name="com/**/**.jui"/>
        </juic>
    </target>

    <target name="compile.java" depends="juic"
            description="Compile the Qt Jambi's core java files.">
        <mkdir dir="${outputDir}" />
        <javac srcdir="${sourceDir}" 
               destdir="${outputDir}"
               memoryMaximumSize="1024m"
               fork="true">
            <include name="com/**/**.java"/>
            <exclude name="com/trolltech/tools/generator/**/**.java"/>
            <exclude name="com/trolltech/demos/HelloGL.java" />
	    <exclude name="com/trolltech/extensions/**/**.java" />
	    <exclude name="com/trolltech/autotests/**/**.java" />
	    <exclude name="com/trolltech/manualtests/**/**.java" />
	    <exclude name="com/trolltech/tests/**/**.java" />
            <exclude name="com/trolltech/examples/GeneratorExample.java" />
        </javac>
    </target>

    <target name="compile.generator-example"
            description="Compile Qt Jambi generator-example.">
	<make dir="generator_example" />
        <javac srcdir="${sourceDir}" destdir="${outputDir}" >
            <include name="com/trolltech/examples/GeneratorExample.java" />
        </javac>
    </target>

    <target name="deploy.jar"
            description="Make a jar file 'qtjambi.jar' that you can include in your project.">
        <jar destfile="qtjambi.jar">
            <manifest>
                <attribute name="Built-By" value="${USER} - ${TODAY}"/>
                <attribute name="Main-Class" value="com.trolltech.launcher.Launcher"/>
            </manifest>
            <fileset dir="${outputDir}" />
            <fileset dir="${sourceDir}">
                <include name="com/trolltech/**/*.png" />
                <include name="com/trolltech/**/*.html" />
                <include name="com/trolltech/**/*.svg" />
		<include name="com/trolltech/**/*.qm" />
                <include name="com/trolltech/examples/ResourceSystem.jar" />
            </fileset>
        </jar>
    </target>

    <target name="generator-example"
            description="Generate code for generator-example, and compile it."
            depends="generator.generator-example, compile.generator-example" />

    <target name="qtjambi"
            description="Make QT Jambi."
            depends="qmake.generator, compile.generator, generator.qtjambi, qmake.qtjambi, compile.qtjambi, compile.java, deploy.jar" />

</project>
