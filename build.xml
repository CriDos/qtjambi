<project default="all" basedir=".">
    <property environment="env"/> 
    <property name="MailLogger.mailhost" value="smtp.trolltech.com" />
    <property name="MailLogger.from" value="[ant-mail]" />
    <property name="MailLogger.failure.notify" value="true" />
    <property name="MailLogger.success.notify" value="true" />
    <property name="MailLogger.failure.to" value="hfroilan@trolltech.com" />
    <property name="MailLogger.success.to" value="hfroilan@trolltech.com" />

    <tstamp/>

    <target name="init">
        <property name="sourceDir" value="." />
        <property name="outputDir" value="classes" />
        <property name="reportDir" value="reports" />
        <property name="htmlDir"   value="/var/www/junit/" />

        <property name="jambiLib" value="./lib" />
        <property name="qt"       value="${env.QTDIR}" />
        <property name="qtLib"    value="${qt}/lib" />
        <property name="config"    value="debug" />

        <property name="deployDir" value="./deploy" />
    </target>

    <target name="clean" depends="init">
        <delete dir="${outputDir}" />
        <delete dir="${jambiLib}" />
    </target>

    <target name="clean.report" depends="init">
         <delete dir="${reportDir}" />
    </target>

    <target name="prepare" depends="clean">
        <mkdir dir="${outputDir}" />
        <mkdir dir="${outputDir}/com/trolltech/autotests" />
    </target>

    <target name="prepare.report" depends="clean.report">
        <mkdir dir="${reportDir}" />
    </target>

    <target name="sync" depends="init">
        <exec executable="p4">
            <arg line="sync //depot/qtjambi/main/..." />
        </exec>
    </target>

    <target name="sync.qt" depends="init">
        <exec executable="p4">
            <arg line="sync //depot/qt/4.3/..." />
        </exec>
    </target>

    <target name="qmake" depends="init">
        <exec executable="make" dir=".">
            <arg line="dist clean -s"/>
        </exec>
        <exec executable="qmake" dir=".">
            <arg line="-r -config ${config}"/>
        </exec>
        <exec executable="make" dir=".">
            <arg line="dist clean -s"/>
        </exec>
    </target>

    <target name="compile.generator" depends="prepare">
        <exec executable="make" dir="generator">
            <arg line="clean -s"/>
        </exec>
        <exec executable="qmake" dir="generator">
            <arg line="-config release"/>
        </exec>
        <exec executable="make" dir="generator">
            <arg line="-s" />
        </exec>
        <exec executable="${basedir}/generator/generator" dir="generator"/>
    </target>

    <target name="compile.qtjambi" depends="prepare">
        <exec executable="make" dir=".">
            <arg line="-s"/>
        </exec>
    </target>

    <target name="juic" depends="prepare">
        <exec executable="./bin/juic" dir=".">
            <arg line="-cp ." />
            <arg line="-a" />
            <arg line="-e eclipse-integration:eclipse-stable" />
            <arg line="-d ${sourceDir}" />
        </exec>
    </target>

    <target name="generator.autotests">
        <exec executable="${basedir}/generator/generator" dir="autotestlib">
            <arg line="global.h build.txt" />
        </exec>
        <exec executable="make" dir="autotestlib">
            <arg line="clean -s"/>
        </exec>
        <exec executable="qmake" dir="autotestlib">
            <arg line="-r -config ${config}"/>
        </exec>
        <exec executable="make"  dir="autotestlib">
           <arg line="-s" />
       </exec>
    </target>

    <target name="generator.example" >
        <exec executable="${basedir}/generator/generator" dir="generator_example">
            <arg line="global.h typesystem_generatorexample.txt" />
        </exec>
        <exec executable="make" dir="generator_example">
            <arg line="clean -s"/>
        </exec>
        <exec executable="qmake" dir="generator_example" >
            <arg line="-r -config  ${config}"/>
        </exec>
        <exec executable="make" dir="generator_example">
           <arg line="-s"/>
        </exec>
    </target>

    <target name="compile" depends="qmake, compile.generator, compile.qtjambi, generator.autotests, generator.example,  compile.java" />

    <target name="configure.qt" depends="init">
        <exec executable="${qt}/configure" dir="${qt}">
	    <arg line="-${config} -no-qt3support -silent" />
	</exec>
    </target>

    <target name="compile.qt" depends="init, sync.qt, configure.qt">
        <exec executable="make" dir="${qt}">
            <arg line="dist clean -s" />
        </exec>
        <exec executable="make" dir="${qt}">
           <arg line="-s"/>
        </exec>
    </target>


    <target name="compile.java" depends="juic">
        <javac srcdir="${sourceDir}" destdir="${outputDir}">
            <include name="com/**/**.java"/>
            <exclude name="com/trolltech/tools/**/**.java"/>
            <exclude name="com/trolltech/demos/HelloGL.java" />
        </javac>
    </target>

    <target name="compile.autotests" depends="init">
        <javac srcdir="${sourceDir}" destdir="${outputDir}" 
               includes="com/trolltech/autotests/**.java" />
    </target>

    <target name="deploy.clean" depends="init">
        <delete dir="${deployDir}" />
        <mkdir dir="${deployDir}" />
    </target>

    <target name="deploy.jar" description="JARs the Task" depends="init">
        <jar destfile="${deployDir}/qtjambi.jar">
            <manifest>
                <attribute name="Built-By" value="Trolltech ASA - ${TODAY}"/>
                <attribute name="Main-Class" value="com.trolltech.launcher.Launcher"/>
            </manifest>
            <fileset dir="${outputDir}" />
            <fileset dir="${sourceDir}">
                <include name="com/trolltech/**" />
            </fileset>
        </jar>
    </target>

    <target name="deploy.linux" depends="deploy.clean, deploy.jar">
        <copy todir="${deployDir}/lib">
            <fileset dir="${jambiLib}">
                <include name="*.so*" />
            </fileset>
        </copy>
        <copy todir="${deployDir}/lib">
            <fileset dir="${qtLib}">
                <include name="*.so*" />
            </fileset>
        </copy>
        <copy file="bin/juic" todir="${deployDir}/bin" />
        <chmod file="${deployDir}/bin/juic" perm="+x"/>
    </target>

    <target name="deploy.zip" depends="init">
        <zip destfile="jambi-devel.zip"
             basedir="${deployDir}"/>
    </target>

    <target name="deploy.tar.gz" depends="deploy.linux">
        <tar tarfile="jambi-devel.tar" basedir="${deployDir}"/>
        <gzip zipfile="jambi-devel.tar.gz" src="jambi-devel.tar"/>
        <delete file="jambi-devel.tar" />
    </target>

    <target name="test" depends="prepare.report" >
        <junit printsummary="yes" haltonfailure="no">
            <!-- comment --> 
            <jvmarg value="-Djava.library.path=${qtLib}:${jambiLib}"/>
            <jvmarg value="-Dcom.trolltech.qt.debug=true"/>
            <classpath>
                <pathelement location="${outputDir}" />
                <pathelement location="${sourceDir}" />
            </classpath>
            <formatter type="xml"/>
            <batchtest fork="true" todir="${reportDir}">
                <fileset dir=".">
                    <include name="**/autotests//Test*.java"/>
                </fileset>
            </batchtest>

        </junit>

        <junitreport todir="${reportDir}">
            <fileset dir="${reportDir}">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="frames" todir="${htmlDir}"/>
        </junitreport>
    </target>

    <target name="all" depends="sync, compile, deploy.linux" />

</project>