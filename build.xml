<project default="qtjambi" basedir=".">

    <property environment="env"/> 

    <tstamp/>

    <property name="sourceDir" value="." />
    <property name="outputDir" value="classes" />

    <property name="jambiLib" value="./lib" />
    <property name="qt"       value="${env.QTDIR}" />
    <property name="qtLib"    value="${qt}/lib" />
    <property name="config"    value="release" />

    <mkdir dir="${outputDir}" />

    <javac srcdir="." destdir="${outputDir}">
        <include name="com/trolltech/tools/ant/*.java"/>
    </javac>
    
    <taskdef name="juic"      classpath="${outputDir}:ant-qtjambi.jar" classname="com.trolltech.tools.ant.JuicTask"/>
    <taskdef name="qmake"     classpath="${outputDir}:ant-qtjambi.jar" classname="com.trolltech.tools.ant.QMakeTask"/>
    <taskdef name="make"      classpath="${outputDir}:ant-qtjambi.jar" classname="com.trolltech.tools.ant.MakeTask"/>
    <taskdef name="generator" classpath="${outputDir}:ant-qtjambi.jar" classname="com.trolltech.tools.ant.GeneratorTask"/>

    <target name="help"
            description="Provides detailed help.">
	<echo>To build Qt Jambi, run ant without parameters.</echo>
	<echo></echo>
        <echo>To get a description of all tasks run: ant -projecthelp</echo>
	<echo/>
	<echo>You can also see the Qt Jambi intallation document at:</echo>
	<echo>http://doc.trolltech.com/qtjambi/com/trolltech/qt/qtjambi-installation.html</echo>
    </target>

    <target name="clean"
            description="Remove the Qt Jambi installation (deletes libraries, class files, and generated Java files).">
        <delete dir="${outputDir}" />
        <delete dir="${jambiLib}" />
    </target>

    <target name="qmake.qtjambi"
            description="Run qmake on the Qt Jambi project.">
        <delete dir="${jambiLib}" />
	<qmake recursive="true" config="${config} sanitycheck"/>
    </target>

    <target name="qmake.generator"
            description="Run qmake on the generator project.">
	<qmake config="release" dir="generator"/>
    </target>

    <target name="compile.generator" depends="qmake.generator"
            description="Compile the Qt Jambi generator.">
        <make dir="generator" target="clean" />
        <make dir="generator" />
    </target>

    <target name="generator.qtjambi" depends="merge.typesystem" 
            description="Run the Qt Jambi generator on the Qt source. It will use the Qt version found in the QTDIR variable.">
        <generator dir="generator"
		   outputDirectory=".."/>
    </target>

    <target name="generator.generator-example" 
            description="Run the generator and qmake on the generator example.">
        <generator dir="generator_example"
	           header="global.h"
                   typesystem="typesystem_generatorexample.txt" 
		   outputDirectory=".."/>
        <qmake recursive="true" config="${config}" dir="generator_example" />

    </target>

    <target name="compile.qtjambi" 
            description="Compile the c++ Qt Jambi bindings.">
	<make />
    </target>

    <target name="juic"
            description="Generates Java source files from JUI files created by designer.">
        <juic message="Running Juic for all it is worth"
	      outputDir="${sourceDir}"
	      xmlConfigFile=""
              trFunction=""
              classNamePrefix=""
              alwaysUpdate="true"
	      classpath=".">
	     <include name="com/**/**.jui"/>
        </juic>
    </target>

    <target name="compile.java" depends="juic"
            description="Compile the Qt Jambi's core java files.">
        <mkdir dir="${outputDir}" />
        <javac srcdir="${sourceDir}" 
               destdir="${outputDir}"
               memoryMaximumSize="1024m"
               fork="true">
            <include name="com/**/**.java"/>
            <exclude name="com/trolltech/tools/generator/**/**.java"/>
            <exclude name="com/trolltech/demos/HelloGL.java" />
	    <exclude name="com/trolltech/extensions/**/**.java" />
	    <exclude name="com/trolltech/autotests/**/**.java" />
	    <exclude name="com/trolltech/manualtests/**/**.java" />
	    <exclude name="com/trolltech/tests/**/**.java" />
            <exclude name="com/trolltech/examples/GeneratorExample.java" />
        </javac>
    </target>

    <target name="compile.generator-example"
            description="Compile Qt Jambi generator-example.">
	<make dir="generator_example" />
        <javac srcdir="${sourceDir}" destdir="${outputDir}" >
            <include name="com/trolltech/examples/GeneratorExample.java" />
        </javac>
    </target>

    <target name="deploy.jar"
            description="Make a .jar file (qtjambi.jar) containing the Qt Jambi classes and examples.">
        <jar destfile="qtjambi.jar">
            <manifest>
                <attribute name="Built-By" value="${USER} - ${TODAY}"/>
                <attribute name="Main-Class" value="com.trolltech.launcher.Launcher"/>
            </manifest>
            <fileset dir="${outputDir}" />
            <fileset dir="${sourceDir}">
                <include name="com/trolltech/**/*.png" />
                <include name="com/trolltech/**/*.html" />
                <include name="com/trolltech/**/*.svg" />
		<include name="com/trolltech/**/*.qm" />
                <include name="com/trolltech/examples/ResourceSystem.jar" />
            </fileset>
        </jar>
    </target>

    <target name="merge.typesystem">
        <xslt in="generator/typesystem_core-common.xml" 
              out="generator/typesystem_core.xml"
              style="generator/merge.xsl"
              force="yes">
            <param name="source"
                   expression="typesystem_core-java.xml"/>
        </xslt>
        <xslt in="generator/typesystem_gui-common.xml" 
              out="generator/typesystem_gui.xml"
              style="generator/merge.xsl"
              force="yes">
            <param name="source"
                   expression="typesystem_gui-java.xml"/>
        </xslt>
        <xslt in="generator/typesystem_network-common.xml" 
              out="generator/typesystem_network.xml"
              style="generator/merge.xsl"
              force="yes">
            <param name="source"
                   expression="typesystem_network-java.xml"/>
        </xslt>
        <xslt in="generator/typesystem_svg-common.xml" 
              out="generator/typesystem_svg.xml"
              style="generator/merge.xsl"
              force="yes">
            <param name="source"
                   expression="typesystem_svg-java.xml"/>
        </xslt>
        <xslt in="generator/typesystem_xml-common.xml" 
              out="generator/typesystem_xml.xml"
              style="generator/merge.xsl"
              force="yes">
            <param name="source"
                   expression="typesystem_xml-java.xml"/>
        </xslt>
        <xslt in="generator/typesystem_opengl-common.xml" 
              out="generator/typesystem_opengl.xml"
              style="generator/merge.xsl"
              force="yes">
            <param name="source"
                   expression="typesystem_opengl-java.xml"/>
        </xslt>
        <xslt in="generator/typesystem_sql-common.xml" 
              out="generator/typesystem_sql.xml"
              style="generator/merge.xsl"
              force="yes">
            <param name="source"
                   expression="typesystem_sql-java.xml"/>
        </xslt>
        <xslt in="generator/typesystem_designer-common.xml" 
              out="generator/typesystem_designer.xml"
              style="generator/merge.xsl"
              force="yes">
            <param name="source"
                   expression="typesystem_designer-java.xml"/>
        </xslt>
    </target>

    <target name="generator-example"
            description="Generate code for generator-example and compile it."
            depends="generator.generator-example, compile.generator-example" />

    <target name="qtjambi"
            description="Build Qt Jambi."
            depends="qmake.generator, compile.generator,generator.qtjambi, qmake.qtjambi, compile.qtjambi, compile.java, deploy.jar" />

</project>
