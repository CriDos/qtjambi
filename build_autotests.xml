<project default="all" basedir=".">

    <property environment="env"/>

    <tstamp/>

    <property name="sourceDir" value="." />
    <property name="outputDir" value="." />

    <property name="jambiLib" value="${outputDir}/lib" />

    <condition property="qtjambi.osx">
      <os family="mac"/>
    </condition>

    <target name="help"
            description="Provides detailed help.">
    <echo>Generates an executable .jar file that runs the generator example...</echo>
    </target>


    <target name="init">
        <taskdef name="qmake"     classpath="${outputDir}/ant-qtjambi.jar" classname="com.trolltech.tools.ant.QMakeTask"/>
        <taskdef name="make"      classpath="${outputDir}/ant-qtjambi.jar" classname="com.trolltech.tools.ant.MakeTask"/>
        <taskdef name="generator" classpath="${outputDir}/ant-qtjambi.jar" classname="com.trolltech.tools.ant.GeneratorTask"/>
        <taskdef name="qtjambi-platform-jar" classpath="${outputDir}/ant-qtjambi.jar" classname="com.trolltech.tools.ant.PlatformJarTask"/>
        <taskdef name="qtjambi-initialize" classpath="${outputDir}/ant-qtjambi.jar" classname="com.trolltech.tools.ant.InitializeTask"/>

        <qtjambi-initialize verbose="true" configuration="${qtjambi.config}" />
    </target>

    <target name="compile.native"
        depends="init">

      <generator dir="${outputDir}/autotestlib"
		 outputDirectory="${outputDir}"
		 typesystem="${sourceDir}/autotestlib/build.txt"
		 header="${sourceDir}/autotestlib/global.h"/>

      <qmake config="${qtjambi.configuration}"
             dir="${outputDir}/autotestlib"
             pro="${sourceDir}/autotestlib/autotestlib.pro" />

      <make dir="${outputDir}/autotestlib" />
    </target>


    <target name="compile.java">
      <javac destdir="${outputDir}"
            debug="true">
        <src path="${outputDir}"/>
        <src path="${sourceDir}"/>
	<include name="com/trolltech/autotests/*.java"/>
        <include name="com/trolltech/autotests/generated/*.java"/>
      </javac>
    </target>

    <target name="run.osx" if="qtjambi.osx">
      <delete dir="${outputDir}/junitxml" />
      <delete dir="${outputDir}/TestResults" />
      <mkdir dir="${outputDir}/junitxml"/>
      <mkdir dir="${outputDir}/TestResults"/>
      <junit fork="yes" printsummary="true" haltonfailure="no" timeout="20000">
	<jvmarg value="-XstartOnFirstThread"/>
	<formatter type="xml" />
	<batchtest fork="yes" todir="${xml}">
          <fileset includes="com/trolltech/autotests/Test*.java"/>
        </batchtest>
      </junit>
    </target>

    <target name="run.other" unless="qtjambi.osx">
      <delete dir="${outputDir}/junitxml" />
      <delete dir="${outputDir}/TestResults" />
      <mkdir dir="${outputDir}/junitxml"/>
      <mkdir dir="${outputDir}/TestResults"/>
      <junit fork="yes" printsummary="true" haltonfailure="no" timeout="20000">
	<formatter type="xml" />
	<batchtest fork="yes" todir="${outputDir}/junitxml">
          <fileset dir="${sourceDir}" includes="com/trolltech/autotests/Test*.java"/>
        </batchtest>
      </junit>
    </target>

    <target name="run" depends="init, run.other, run.osx" description="Runs tests and generates report in TestReport subdir">
      <junitreport todir="${outputDir}/junitxml">
	<fileset dir="${outputDir}/junitxml">
	  <include name="TEST-*.xml" />
	</fileset>
	<report format="frames" todir="${outputDir}/TestResults" />
      </junitreport>
    </target>

    <target name="compile" 
	    depends="compile.native, compile.java"/>
    
    <target name="all"
        depends="init, compile, run" />

</project>
