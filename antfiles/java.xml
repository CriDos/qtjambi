<project name="qtjambi.java">
    <!--
        Pure Java jar targets:

        * ant-qtjambi.jar contains the code for many ant tasks used along the
          file (qmake, make, generator, juic...);
        * qtjambi.jar is the core jar for Qt Jambi applications;
        * qtjambi-designer.jar is the Java equivalent of Qt Designer;
        * qtjambi-examples.jar is a jar containing examples of Qt Jambi in
          action.

        Some of them, like jar.qtjambi, depend on other parts of this build
        file.

        As you will see, each of these targets is preceeded by a fileset. The
        rule is to create a fileset with id "java.src.<modulenamehere>" and to
        call the ant jar.xml file with inheritrefs=true (otherwise it will NOT
        see the defined fileset).

        TODO: refactor. Names are horrible, atleast
    -->

    <target name="jar.ant-qtjambi" depends="jar.qtjambi-util"
        description="Creates a .jar file containing all the Qt Jambi ant tasks.">
        <ant antfile="antfiles/jar.xml" inheritrefs="true">
            <property name="module" value="ant-qtjambi"/>
            <property name="destdir" value="${jardir}/nobundle"/>
            <property name="sourcedir" value="${java.srcdir}/ant-qtjambi"/>
        </ant>
    </target>

    <target name="jar.qtjambi-util">
        <ant antfile="antfiles/jar.xml" inheritrefs="true" target="makejar.qtjambi-util">
            <property name="module" value="qtjambi-util"/>
            <property name="sourcedir" value="${java.srcdir}/qtjambi-util"/>
        </ant>
    </target>

    <target name="jar.qtjambi" depends="init, jar.qtjambi-util">
        <qtjambi-version-properties verbose="true"/>
        <!-- 1. This is a fix for adding the OsInfo class to the the main jar-->
        <!--
            2. Copy version.properties to generated dir for packaging.
            TODO: version.properties shouldnâ€™t be copied in first place.
        -->
        <echo message="${java.outdir}"/>
        <copy todir="${java.outdir}/qtjambi">
            <fileset dir="${java.outdir}/qtjambi-util">
                <include name="**/*"/>
            </fileset>
        </copy>
        <copy todir="${java.outdir}/qtjambi/com/trolltech/qt">
            <fileset dir=".">
                <include name="version.properties" />
            </fileset>
        </copy>
        <ant antfile="antfiles/jar.xml" inheritrefs="true" target="makejar.qtjambi">
            <property name="module" value="qtjambi"/>
            <property name="jar.excludes" value="com/trolltech/tools/**"/>
            <property name="sourcedir" value="${java.srcdir}/qtjambi"/>
            <property name="sourcedir2" value="${generator.outputdir}/java"/>
        </ant>
    </target>

    <target name="jar.qtjambi-designer" depends="init, jar.qtjambi">
        <ant antfile="antfiles/jar.xml" inheritrefs="true" target="makejar.qtjambi-designer">
            <property name="module" value="qtjambi-designer"/>
            <!-- Keep com/trolltech/qt/designer/**-->
            <property name="jar.excludes" value="com/trolltech/qt/core/**,com/trolltech/qt/designer/**,com/trolltech/qt/gui/**,com/trolltech/qt/help/**,com/trolltech/qt/multimedia/**,com/trolltech/qt/network/**,com/trolltech/qt/opengl/**,com/trolltech/qt/phonon/**,com/trolltech/qt/script/**,com/trolltech/qt/scripttools/**,com/trolltech/qt/sql/**,com/trolltech/qt/svg/**,com/trolltech/qt/webkit/**,com/trolltech/qt/xml/**,com/trolltech/qt/xmlpatterns/**"/>
            <property name="sourcedir" value="${java.srcdir}/qtjambi-designer"/>
            <property name="sourcedir2" value="${generator.outputdir}/java"/><!-- duped with jar.qtjambi -->
        </ant>
    </target>

    <!-- This fileset looks unused/redundant -->
    <fileset id="java.src.qtjambi-examples" dir="${java.srcdir}/qtjambi-examples">
        <include name="**/*.java"/>
        <exclude name="src/java/qtjambi-examples/com/trolltech/demos/phonon/*.java"
            unless="qtjambi.phonon"/>
        <exclude name="com/trolltech/examples/phonon/*.java"
            unless="qtjambi.phonon"/>
        <exclude name="src/java/qtjambi-examples/com/trolltech/demos/xmlpatterns/*.java"
            unless="qtjambi.xmlpatterns"/>
        <exclude name="src/java/qtjambi-examples/com/trolltech/examples/xmlpatterns/*.java"
            unless="qtjambi.xmlpatterns"/>
        <exclude name="src/java/qtjambi-examples/com/trolltech/demos/webkit/*.java"
            unless="qtjambi.webkit"/>
        <exclude name="src/java/qtjambi-examples/com/trolltech/examples/webkit/*.java"
            unless="qtjambi.webkit"/>
        <exclude name="src/java/qtjambi-examples/com/trolltech/examples/opengl/*.java"
            unless="qtjambi.opengl"/>
        <exclude name="src/java/qtjambi-examples/com/trolltech/demos/opengl/*.java"
            unless="qtjambi.opengl"/>
        <exclude name="src/java/qtjambi-examples/com/tolltech/examples/SvgCards.java"
            unless="qtjambi.svg"/>
    </fileset>

    <target name="jar.qtjambi-examples.juic" depends="tools.juic.make">
        <dojuic module="qtjambi-examples"/>
    </target>

    <target name="jar.qtjambi-examples" depends="init, jar.qtjambi-designer, jar.qtjambi-examples.juic">
        <!-- exclude java classes, which were not build, depending on qtjambi config -->
        <condition property="javac.opengl.excludes" value="**/opengl/**/*.java">
            <isfalse value="${qtjambi.opengl}"/>
        </condition>
        <condition property="javac.xmlpatterns.excludes" value="**/xmlpatterns/**/*.java">
            <isfalse value="${qtjambi.xmlpatterns}"/>
        </condition>
        <condition property="javac.phonon.excludes" value="**/phonon/**/*.java">
            <isfalse value="${qtjambi.phonon}"/>
        </condition>
        <condition property="javac.webkit.excludes" value="**/webkit/**/*.java">
            <isfalse value="${qtjambi.webkit}"/>
        </condition>
        <condition property="javac.svg.excludes" value="**/SvgCards.java">
            <isfalse value="${qtjambi.svg}"/>
        </condition>
        <condition property="javac.extra.excludes" value="com/trolltech/examples/Styles.java">
            <istrue value="${qt.feature.QT_NO_STYLE_MOTIF}"/><!-- Styles.java needs QMotifStyle -->
        </condition>
        <property name="javac.excludes" value="${javac.opengl.excludes}
                                               ${javac.xmlpatterns.excludes}
                                               ${javac.phonon.excludes}
                                               ${javac.webkit.excludes}
                                               ${javac.svg.excludes}
                                               ${javac.extra.excludes}"/>
        <echo message="processed excludes ${javac.excludes}"/>
        <ant antfile="antfiles/jar.xml" inheritrefs="true" target="makejar.qtjambi-examples">
            <property name="module" value="qtjambi-examples"/>
            <property name="module.excludes" value="${javac.excludes}"/>
            <property name="sourcedir" value="${java.srcdir}/qtjambi-examples"/>
            <property name="sourcedir2" value="${juic.outputdir}/qtjambi-examples"/>
        </ant>
    </target>
</project>
