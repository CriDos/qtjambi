<project name="qtjambi.generator">
    <!--
        ************************************************************
        Building and running the Generator...
        ************************************************************
    -->

    <target name="generator.run" depends="init, tools.generator.make"
        description="Runs the Qt Jambi generator on the Qt headers">
        <mkdir dir="${generator.outputdir}"/>
        <generator dir="${generatorDir}"
                outputDirectory="${generator.outputdir}"
                typesystem="${generatorDir}/targets/build_all.xml"
                header="${generatorDir}/targets/qtjambi_masterinclude.h"
                phononpath="${qtjambi.phonon.includedir}"
                qtincludedirectory="${qtjambi.qt.includedir}"
                options="${qtjambi.generator.jumptable}"/>
    </target>

    <target name="generator.cppsrc" depends="generator.run">
        <copy todir="${outputDir}">
            <fileset dir="${generator.outputdir}" includes="cpp/**/*"/>
        </copy>
    </target>

    <target name="generator.javasrc.qtjambi" depends="generator.run">
        <mkdir dir="${java.generated.srcdir}/qtjambi"/>
        <copy todir="${java.generated.srcdir}/qtjambi"
            includeemptydirs="false">
            <fileset dir="${generator.outputdir}">
                <include name="**/*"/>
                <exclude name="com/trolltech/tools/designer/**"/>
                <exclude name="cpp/**/*"/>
            </fileset>
        </copy>
        <zip destfile="qtjambi-${qtjambi.version}-src.zip" basedir="java/src/qtjambi">
        </zip>
        <zip destfile="qtjambi-${qtjambi.version}-src.zip" basedir="${java.generated.srcdir}/qtjambi" update="true">
        </zip>
    </target>

    <target name="generator.javasrc.qtjambi-designer" depends="generator.run">
        <mkdir dir="${java.generated.srcdir}/qtjambi-designer"/>
        <copy todir="${java.generated.srcdir}/qtjambi-designer"
            includeemptydirs="false">
            <fileset dir="${generator.outputdir}"
                includes="com/trolltech/tools/designer/**"/>
        </copy>
    </target>

    <!--
        ************************************************************
        XML Merging for the generator...
        ************************************************************
    -->

    <macrodef name="xmlmerge">
        <attribute name="victim"/>
        <sequential>
            <xslt force="true" style="${generator.xmlmerge.srcdir}/merge.xsl"
                in="${generator.xmlmerge.srcdir}/typesystem_@{victim}-common.xml"
                out="${generator.xmlmerge.outputdir}/typesystem_@{victim}.xml">
                <param name="source"
                    expression="typesystem_@{victim}-java.xml"/>
            </xslt>
        </sequential>
    </macrodef>

    <target name="generator.xmlmerge"
        description="Merges the XML files used by the Qt Jambi generator.">
        <xmlmerge victim="core"/>
        <xmlmerge victim="gui"/>
        <xmlmerge victim="xml"/>
        <xmlmerge victim="network"/>
        <xmlmerge victim="opengl"/>
        <xmlmerge victim="sql"/>
        <xmlmerge victim="svg"/>
        <xmlmerge victim="help"/>
        <xmlmerge victim="multimedia"/>
        <xmlmerge victim="webkit"/>
        <xmlmerge victim="phonon"/>
        <xmlmerge victim="xmlpatterns"/>
        <xmlmerge victim="designer"/>
        <xmlmerge victim="script"/>
        <xmlmerge victim="scripttools"/>
    </target>

    <target name="generator" depends="generator.run"
        description="Compiles and runs the Qt Jambi Generator."/>

    <target name="library.native" depends="library.native.bundle"
        description="Compiles and bundles the Qt Jambi native libraries."/>

    <target name="library.java" depends="library.java.bundle"
        description="Compiles and bundles the Qt Jambi java libraries."/>

    <target name="library.designer" depends="library.designer.bundle"
        description="Compiles and bundles the Qt Jambi designer libraries."/>

    <target name="library" depends="library.native, library.java, library.designer"
        description="Compiles and bundles the Qt Jambi libraries.">
        <copy file="${jardir}/qtjambi-util.jar"
            tofile="qtjambi-util-${qtjambi.version}.jar"/>
    </target>

    <target name="examples" depends="examples.bundle"
        description="Compiles and bundles the Qt Jambi examples."/>

    <target name="all" depends="library, examples"
        description="Generates, builds and bundles the Qt Jambi libraries."/>

</project>